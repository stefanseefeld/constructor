

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Basic concepts - Faber 1.0 documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '1.0',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="Faber 1.0 documentation" href="../index.html" />
    <link rel="up" title="Faber Tutorial" href="index.html" />
    <link rel="next" title="Advanced concepts" href="advanced_concepts.html" />
    <link rel="prev" title="Faber Tutorial" href="index.html" /> 
  </head>
  <body>
    <div class="header">
    <table border="0" cellpadding="7" cellspacing="0" width="100%" summary=
    "header">
      <tr>
        <td valign="top" width="300">
          <h3><a href="../index.html"><img 
          alt="C++ Boost" src="../_static/logo.png" border="0"></a></h3>
        </td>
	<td>
      <div id="searchbox" style="display: none">
        <form class="search" action="../search.html" method="get">
          <input type="text" name="q" size="18" />
          <input type="submit" value="Search" />
          <input type="hidden" name="check_keywords" value="yes" />
          <input type="hidden" name="area" value="default" />
        </form>
      </div>
      <script type="text/javascript">$('#searchbox').show(0);</script>
	</td>
      </tr>
    </table>
    </div>
    <hr/>
    <div class="content">
    <div class="navbar" style="text-align:right;">
      
      
      <a class="prev" title="Faber Tutorial" href="index.html"><img src="../_static/prev.png" alt="prev"/></a>
      <a class="up" title="Faber Tutorial" href="index.html"><img src="../_static/up.png" alt="up"/></a>
      <a class="next" title="Advanced concepts" href="advanced_concepts.html"><img src="../_static/next.png" alt="next"/></a>
      
    </div>
      
  <div class="section" id="basic-concepts">
<h1>Basic concepts</h1>
<p>In the previous section we have seen a compact way to define a simple build logic to
compile a binary from C++ source code, and test it. A <cite>binary</cite> is an example of a
<cite>composite artefact</cite>. In order to understand that, we first need to take a step back
and look at a few more basic building blocks out of which such higher-level constructs
are composed.
The central concepts in <cite>faber</cite> are <em>artefacts</em>, which are generated using <em>actions</em>.
In the simplest case, artefacts are declared using <em>rules</em>, which instruct faber how
to generate artefacts, possibly from other (&quot;source&quot;) artefacts.</p>
<p>So to appreciate this mechanism, let's rebuild the previous example from these
foundational building blocks. Consider this <cite>fabscript</cite>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># define some actions</span>
<span class="nb">compile</span> <span class="o">=</span> <span class="n">action</span><span class="p">(</span><span class="s1">&#39;c++.compile&#39;</span><span class="p">,</span> <span class="s1">&#39;c++ -c -o $(&lt;) $(&gt;)&#39;</span><span class="p">)</span>
<span class="n">link</span> <span class="o">=</span> <span class="n">action</span><span class="p">(</span><span class="s1">&#39;c++.link&#39;</span><span class="p">,</span> <span class="s1">&#39;c++ -o $(&lt;) $(&gt;)&#39;</span><span class="p">)</span>

<span class="c1"># bind artefacts to sources using the above recipes</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="s1">&#39;hello.o&#39;</span><span class="p">,</span> <span class="s1">&#39;hello.cpp&#39;</span><span class="p">)</span>
<span class="nb">bin</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span><span class="n">action</span><span class="p">(</span><span class="s1">&#39;run_test&#39;</span><span class="p">,</span> <span class="s1">&#39;./$(&gt;)&#39;</span><span class="p">),</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="nb">bin</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">notfile</span><span class="o">|</span><span class="n">always</span><span class="p">)</span>

<span class="n">default</span> <span class="o">=</span> <span class="nb">bin</span>
</pre></div>
</div>
<p>In the following sections we will dissect this build logic to understand the individual
items, before we then move on to higher level abstractions.</p>
<div class="section" id="actions-and-recipes">
<h2>Actions and recipes</h2>
<p>The following line defines a very simple action called <cite>c++.compile</cite>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">compile</span> <span class="o">=</span> <span class="n">action</span><span class="p">(</span><span class="s1">&#39;c++.compile&#39;</span><span class="p">,</span> <span class="s1">&#39;c++ -c -o $(&lt;) $(&gt;)&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>It can be used as a recipe in a rule to compile an object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="s1">&#39;hello.o&#39;</span><span class="p">,</span> <span class="s1">&#39;hello.cpp&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The action has a name, which will be reported as the build process progresses, as well
as a command, which will be executed in a platform-specific shell. Such commands may
use variables (<cite>$(...)</cite>) which are substituted when the action is bound to specific
targets and sources, that is, when it is instantiated into a <cite>recipe</cite>.
In the above case the two variables <cite>&lt;</cite> and <cite>&gt;</cite> are being substituted
for target and source respectively, so the command will actually be:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>c++ -c -o hello.o hello.cpp
</pre></div>
</div>
<p>It is also possible to use Python functions as actions, with the following calling convention:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">do_something</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="p">[]):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>that is, the function should take one or two arguments, the first being a list of target
artefacts (which this function should generate or update), as well as an optional list
of source artefacts, serving as input.</p>
<p>Actions may also be called explicitly from inside functions. Consider the example from the
previous chapter where we defined a <cite>run_test</cite> action to update a <cite>test</cite> artefact:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">test</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span><span class="n">action</span><span class="p">(</span><span class="s1">&#39;run_test&#39;</span><span class="p">,</span> <span class="s1">&#39;./$(&gt;)&#39;</span><span class="p">),</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="nb">bin</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">notfile</span><span class="o">|</span><span class="n">always</span><span class="p">)</span>
</pre></div>
</div>
<p>We could adorn this action with some output to indicate whether the test passed or failed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">run</span> <span class="o">=</span> <span class="n">action</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;./$(&gt;)&#39;</span><span class="p">)</span>

<span class="c1"># python functions may be actions, too</span>
<span class="k">def</span> <span class="nf">run_test</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;performing </span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    <span class="c1"># actions may also be called explicitly</span>
    <span class="k">if</span> <span class="n">run</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...success.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...failed.&#39;</span><span class="p">)</span>

<span class="n">test</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span><span class="n">run_test</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="nb">bin</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">notfile</span><span class="o">|</span><span class="n">always</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that the new <cite>run_test</cite> recipe has become a (Python) function, still using the same
name as before, but instead of using a (shell) command, now being executed in-process.
The function itself explicitly calls the action <cite>run</cite>, but performs additional work before
and after that. While in this case this is a trivial print, this can be arbitrarily complex
logic, using the full power of Python.
In the above, we print out the name of the first target (in our fabscript there will only be
one). We will cover the <a class="reference internal" href="../glossary.html#term-artefact"><span class="xref std std-term">artefact</span></a> API including the <cite>name</cite> property a little later.</p>
</div>
<div class="section" id="rules-dependencies-aliases">
<h2>Rules, dependencies, aliases</h2>
<p>As mentioned before, <a class="reference internal" href="../glossary.html#term-rule"><span class="xref std std-term">rule</span></a>s are used to declare how to make (or update) target
artefacts from sources. In the simplest case a rule is called with two arguments: the action
to perform, and the target to generate or update. It will return an <cite>artefact</cite> instance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">output</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span><span class="n">build</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>As we have already seen, the action argument may either be an action instance, or a Python
function (or more generally: <cite>callable</cite>). The target argument may be one or more strings
(target names), or artefact instances. (While most actions generate an individual target,
some generate more than one.)
The most common case, though, includes also a <cite>sources</cite> argument, which has the same type
as the <cite>target</cite> argument: one or more names or artefact instances.</p>
<p>In addition, there are additional (optional) arguments. For the full list please refer
to the reference manual. Here we describe the most common ones:</p>
<ul class="simple">
<li><p>dependencies: a list of artefacts that need to be up-to-date before this rule may be invoked</p></li>
<li><p>attrs: attributes to be set for this artefact:</p>
<ul>
<li><p>notfile: the artefact is not a file</p></li>
<li><p>always: never consider this artefact up-to-date</p></li>
<li><p>nocare: allow the update of this artefact to fail</p></li>
</ul>
</li>
<li><p>features: a set of features to be associated with this artefact</p></li>
</ul>
<p>In addition to the <cite>rule</cite> function that declares how to update a target artefact
using a recipe, it may be desirable to merely declare a dependency:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">depend</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>  <span class="c1"># make sure b is up to date before a is updated</span>
</pre></div>
</div>
<p>or to define an 'alias' for one or more other artefacts:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">])</span>  <span class="c1"># update a, b, and c whenever `faber all` is called</span>
</pre></div>
</div>
</div>
<div class="section" id="features">
<h2>Features</h2>
<p>Features allow a build process to be parametrized by injecting variables into
actions, as well as into the logic that is used to decide which artefacts to
generate or update.</p>
<p>Values may be defined globally, for example as command-line options:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ faber variant=release target.os=w64
</pre></div>
</div>
<p>or per artefact:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lib</span><span class="o">=</span><span class="n">library</span><span class="p">(</span><span class="s1">&#39;greet&#39;</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="s1">&#39;greet.cpp&#39;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">link</span><span class="p">(</span><span class="s1">&#39;shared&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>An individual feature corresponds to a variable (e.g. 'variant', 'target.os',
or 'link', in the above examples), which may hold different values (e.g.
'release', 'w64', 'shared').
Features are typically defined in a domain-specific context. &quot;define&quot;, &quot;include&quot;,
and &quot;link&quot; are features defined in the context of C/C++ compilation, while
&quot;target.os&quot; is a feature more generally useful to describe the system binary
artefacts will run on).</p>
<p>As different commands will use different flags based on their values, these
values are <cite>mapped</cite> to command-specific variables as recipes are instantiated
for a given target artefact. Consider the <cite>compile</cite> action we already encountered,
now augmented by a flag to set an include path. A somewhat more advanced version
suitable to be used with <cite>g++</cite> on Linux may look somewhat like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">compile</span><span class="p">(</span><span class="n">action</span><span class="p">):</span>

    <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;g++ $(cppflags) -c -o $(&lt;) $(&gt;)&#39;</span>
    <span class="n">cppflags</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">compiler</span><span class="o">.</span><span class="n">include</span><span class="p">,</span> <span class="n">translate</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;-I&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>i.e. a <cite>cppflags</cite> variable (referenced in the action command) is generated from
a platform-agnostic <cite>compiler.include</cite> feature by prefixing all values with '-I'.</p>
<p>This powerful mechanism allows complex build logic to be separated into a generic
part that maps platform-agnostic features to platform-specific tools and commands,
and an application-specific part that is focused on the semantics of their build
system, without having to think about (or in fact know) all platforms they want
to support.</p>
<p>While in the simplest case feature values are defined statically, they may also
be computed dynamically as an artefact is updated. We will look more into the
resulting complexities of such data flows in a later chapter.</p>
</div>
<div class="section" id="artefacts">
<h2>Artefacts</h2>
<p>An <a class="reference internal" href="../glossary.html#term-artefact"><span class="xref std std-term">artefact</span></a> is the central concept at the heart of <cite>faber</cite>. Typically,
artefacts are declared using <cite>rules</cite> as described in earlier sections, or as
<cite>aliases</cite> to other artefacts. While we leave the full description of the
associated API to the reference manual, here are a few frequently used properties:</p>
<ul class="simple">
<li><dl class="simple">
<dt>name: the (unqualified) name of the artefact. In a simple case, this also corresponds</dt><dd><p>to the name by which it can be invoked via <cite>faber &lt;name&gt;</cite></p>
</dd>
</dl>
</li>
<li><p>features: the feature set used to update the artefact</p></li>
<li><p>boundname: the filename if this artefact corresponds to a file, a simple name otherwise.</p></li>
</ul>
<p>Domain-specific artefacts may be constructed directly, rather than by virtue of a <cite>rule</cite> call.
Examples include configure checks, test execution and reporting, or composite artefacts
to build libraries or binaries from sources.
All of those will be discussed in detail in later chapters.</p>
</div>
</div>


    <div class="navbar" style="text-align:right;">
      
      
      <a class="prev" title="Faber Tutorial" href="index.html"><img src="../_static/prev.png" alt="prev"/></a>
      <a class="up" title="Faber Tutorial" href="index.html"><img src="../_static/up.png" alt="up"/></a>
      <a class="next" title="Advanced concepts" href="advanced_concepts.html"><img src="../_static/next.png" alt="next"/></a>
      
    </div>
    </div>
    <div class="footer">
      <p>last updated Feb 07, 2021</p>
    </div>
  </body>
</html>